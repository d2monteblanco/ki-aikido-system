<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Ki Aikido - Gestão de Alunos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .hidden { display: none; }
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
        <div class="max-w-md w-full space-y-8">
            <div class="text-center">
                <div class="flex justify-center">
                    <div class="flex h-16 w-16 items-center justify-center rounded-full bg-blue-600 shadow-lg">
                        <i data-lucide="zap" class="h-8 w-8 text-white"></i>
                    </div>
                </div>
                <h2 class="mt-6 text-3xl font-bold text-gray-900">Sistema Ki Aikido</h2>
                <p class="mt-2 text-sm text-gray-600">Gestão de Alunos das Academias</p>
            </div>

            <div class="bg-white shadow-xl rounded-lg p-8">
                <h3 class="text-lg font-semibold mb-4">Entrar no Sistema</h3>
                
                <div id="loginError" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                    <div class="flex items-center">
                        <i data-lucide="alert-circle" class="h-4 w-4 mr-2"></i>
                        <span id="loginErrorText"></span>
                    </div>
                </div>

                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="loginEmail" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="seu@email.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                        <input type="password" id="loginPassword" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Sua senha">
                    </div>
                    
                    <button type="submit" id="loginBtn"
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span id="loginBtnText">Entrar</span>
                        <i data-lucide="loader-2" class="hidden h-4 w-4 animate-spin inline ml-2" id="loginSpinner"></i>
                    </button>
                </form>

                <!-- Demo Credentials -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Credenciais de Demonstração:</h4>
                    <div class="space-y-2 text-xs">
                        <button type="button" onclick="fillLogin('admin@kiaikido.com')" 
                                class="block w-full text-left p-2 hover:bg-gray-100 rounded">
                            <div class="font-medium">admin@kiaikido.com</div>
                            <div class="text-gray-500">Administrador (vê todos os dojos)</div>
                        </button>
                        <button type="button" onclick="fillLogin('florianopolis@kiaikido.com')" 
                                class="block w-full text-left p-2 hover:bg-gray-100 rounded">
                            <div class="font-medium">florianopolis@kiaikido.com</div>
                            <div class="text-gray-500">Dojo Florianópolis</div>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Senha para todos: 123456</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-3">
                        <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-blue-600">
                            <i data-lucide="zap" class="h-5 w-5 text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold text-gray-900">Ki Aikido</h1>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <span id="userInfo" class="text-sm text-gray-600"></span>
                        <button onclick="logout()" class="text-sm text-gray-500 hover:text-gray-700">
                            <i data-lucide="log-out" class="h-4 w-4 inline mr-1"></i>
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Stats -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Dashboard</h2>
                <p class="text-gray-600 mb-6">Bem-vindo ao sistema Ki Aikido</p>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total de Alunos</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalStudents">0</p>
                            </div>
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <i data-lucide="users" class="h-6 w-6 text-blue-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Alunos Ativos</p>
                                <p class="text-2xl font-bold text-gray-900" id="activeStudents">0</p>
                            </div>
                            <div class="p-2 bg-green-100 rounded-lg">
                                <i data-lucide="user-check" class="h-6 w-6 text-green-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Pendentes</p>
                                <p class="text-2xl font-bold text-gray-900" id="pendingStudents">0</p>
                            </div>
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <i data-lucide="user-x" class="h-6 w-6 text-yellow-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Dojos</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalDojos">0</p>
                            </div>
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <i data-lucide="building-2" class="h-6 w-6 text-purple-600"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Students Section -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Gestão de Alunos</h3>
                        <button onclick="showCreateModal()" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <i data-lucide="plus" class="h-4 w-4 inline mr-2"></i>
                            Novo Aluno
                        </button>
                    </div>
                </div>

                <!-- Students List -->
                <div class="p-6">
                    <div id="studentsLoading" class="text-center py-8">
                        <i data-lucide="loader-2" class="h-8 w-8 animate-spin mx-auto mb-4 text-gray-400"></i>
                        <p class="text-gray-500">Carregando alunos...</p>
                    </div>
                    
                    <div id="studentsEmpty" class="hidden text-center py-8">
                        <i data-lucide="users" class="h-12 w-12 mx-auto mb-4 text-gray-400"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhum aluno encontrado</h3>
                        <p class="text-gray-500">Comece cadastrando o primeiro aluno.</p>
                    </div>
                    
                    <div id="studentsList" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Students will be populated here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Student Modal -->
    <div id="createModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Cadastrar Novo Aluno</h3>
                    <button onclick="hideCreateModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                
                <div id="createError" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                    <div class="flex items-center">
                        <i data-lucide="alert-circle" class="h-4 w-4 mr-2"></i>
                        <span id="createErrorText"></span>
                    </div>
                </div>

                <form id="createForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nome Completo *</label>
                            <input type="text" id="createName" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                            <input type="email" id="createEmail" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data de Nascimento *</label>
                            <input type="date" id="createBirthDate" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dojo *</label>
                            <select id="createDojo" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Selecione o dojo</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Endereço Completo *</label>
                        <textarea id="createAddress" required rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="hideCreateModal()"
                                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" id="createBtn"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <span id="createBtnText">Salvar Aluno</span>
                            <i data-lucide="loader-2" class="hidden h-4 w-4 animate-spin inline ml-2" id="createSpinner"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let students = [];
        let dojos = [];

        // API Base URL
        const API_BASE = 'http://localhost:5000/api';

        // Initialize Lucide icons
        lucide.createIcons();

        // API Helper functions
        async function apiRequest(endpoint, options = {}) {
            const url = API_BASE + endpoint;
            const token = localStorage.getItem('authToken');
            
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` }),
                    ...options.headers,
                },
                ...options,
            };

            try {
                const response = await fetch(url, config);
                const data = await response.json();
                
                if (!response.ok) {
                    // Se token expirou, limpar localStorage e redirecionar para login
                    if (response.status === 401 && token) {
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');
                        showLoginScreen();
                    }
                    throw new Error(data.error || 'HTTP error! status: ' + response.status);
                }
                
                return data;
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }

        // Authentication functions
        function fillLogin(email) {
            document.getElementById('loginEmail').value = email;
            document.getElementById('loginPassword').value = '123456';
        }

        async function login(email, password) {
            try {
                const response = await apiRequest('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password }),
                });
                
                // Armazenar token e usuário no localStorage
                localStorage.setItem('authToken', response.token);
                localStorage.setItem('currentUser', JSON.stringify(response.user));
                currentUser = response.user;
                
                return { success: true, user: response.user };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function logout() {
            try {
                await apiRequest('/auth/logout', { method: 'POST' });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                // Limpar localStorage
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentUser');
                currentUser = null;
                showLoginScreen();
            }
        }

        // UI functions
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateUserInfo();
            loadData();
        }

        function updateUserInfo() {
            if (currentUser) {
                const userInfo = currentUser.name + (currentUser.dojo_name ? ' - ' + currentUser.dojo_name : '');
                document.getElementById('userInfo').textContent = userInfo;
            }
        }

        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            const errorText = document.getElementById(elementId + 'Text');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        function setLoading(buttonId, spinnerId, textId, loading, loadingText) {
            const button = document.getElementById(buttonId);
            const spinner = document.getElementById(spinnerId);
            const text = document.getElementById(textId);
            
            if (loading) {
                button.disabled = true;
                spinner.classList.remove('hidden');
                text.textContent = loadingText || 'Carregando...';
            } else {
                button.disabled = false;
                spinner.classList.add('hidden');
                text.textContent = buttonId === 'loginBtn' ? 'Entrar' : 'Salvar Aluno';
            }
        }

        // Data loading functions
        async function loadData() {
            try {
                // Load dojos
                const dojosResponse = await apiRequest('/dojos');
                dojos = dojosResponse.dojos;
                populateDojoSelects();
                
                // Load students
                await loadStudents();
                
                // Load stats
                await loadStats();
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadStudents() {
            try {
                document.getElementById('studentsLoading').classList.remove('hidden');
                document.getElementById('studentsEmpty').classList.add('hidden');
                document.getElementById('studentsList').classList.add('hidden');
                
                const response = await apiRequest('/students');
                students = response.students;
                
                if (students.length === 0) {
                    document.getElementById('studentsLoading').classList.add('hidden');
                    document.getElementById('studentsEmpty').classList.remove('hidden');
                } else {
                    renderStudents();
                    document.getElementById('studentsLoading').classList.add('hidden');
                    document.getElementById('studentsList').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('studentsLoading').classList.add('hidden');
                document.getElementById('studentsEmpty').classList.remove('hidden');
            }
        }

        async function loadStats() {
            try {
                const response = await apiRequest('/students/stats');
                const stats = response.stats;
                
                document.getElementById('totalStudents').textContent = stats.total || 0;
                document.getElementById('activeStudents').textContent = stats.active || 0;
                document.getElementById('pendingStudents').textContent = stats.pending || 0;
                document.getElementById('totalDojos').textContent = dojos.length || 0;
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function populateDojoSelects() {
            const select = document.getElementById('createDojo');
            select.innerHTML = '<option value="">Selecione o dojo</option>';
            
            dojos.forEach(dojo => {
                const option = document.createElement('option');
                option.value = dojo.id;
                option.textContent = dojo.name;
                select.appendChild(option);
            });
        }

        function renderStudents() {
            const container = document.getElementById('studentsList');
            container.innerHTML = '';
            
            students.forEach(student => {
                const studentCard = createStudentCard(student);
                container.appendChild(studentCard);
            });
        }

        function createStudentCard(student) {
            const card = document.createElement('div');
            card.className = 'bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow';
            
            const statusColors = {
                active: 'bg-green-100 text-green-800',
                pending: 'bg-yellow-100 text-yellow-800',
                inactive: 'bg-red-100 text-red-800'
            };
            
            const statusLabels = {
                active: 'Ativo',
                pending: 'Pendente',
                inactive: 'Inativo'
            };
            
            card.innerHTML = '<div class="flex justify-between items-start mb-4">' +
                '<div class="flex-1">' +
                '<h4 class="text-lg font-semibold text-gray-900">' + student.name + '</h4>' +
                '<p class="text-sm text-gray-600 flex items-center mt-1">' +
                '<i data-lucide="mail" class="h-3 w-3 mr-1"></i>' +
                student.email +
                '</p>' +
                '</div>' +
                '<span class="px-2 py-1 text-xs font-medium rounded-full ' + (statusColors[student.status] || statusColors.active) + '">' +
                (statusLabels[student.status] || 'Ativo') +
                '</span>' +
                '</div>' +
                '<div class="space-y-2 text-sm text-gray-600">' +
                '<div class="flex items-center">' +
                '<span class="font-medium">Registro:</span>' +
                '<span class="ml-2">' + student.registration_number + '</span>' +
                '</div>' +
                '<div class="flex items-center">' +
                '<span class="font-medium">Dojo:</span>' +
                '<span class="ml-2">' + student.dojo_name + '</span>' +
                '</div>' +
                '<div class="flex items-center">' +
                '<i data-lucide="calendar" class="h-3 w-3 mr-1"></i>' +
                '<span class="font-medium">Nascimento:</span>' +
                '<span class="ml-2">' + formatDate(student.birth_date) + '</span>' +
                '</div>' +
                '<div class="flex items-start">' +
                '<i data-lucide="map-pin" class="h-3 w-3 mr-1 mt-0.5 flex-shrink-0"></i>' +
                '<span class="text-xs">' + student.address + '</span>' +
                '</div>' +
                '</div>';
            
            return card;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        // Modal functions
        function showCreateModal() {
            document.getElementById('createModal').classList.remove('hidden');
            document.getElementById('createForm').reset();
            hideError('createError');
        }

        function hideCreateModal() {
            document.getElementById('createModal').classList.add('hidden');
        }

        async function createStudent(formData) {
            try {
                const response = await apiRequest('/students', {
                    method: 'POST',
                    body: JSON.stringify(formData),
                });
                
                return { success: true, student: response.student };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // Event listeners
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            hideError('loginError');
            setLoading('loginBtn', 'loginSpinner', 'loginBtnText', true, 'Entrando...');
            
            const result = await login(email, password);
            
            if (result.success) {
                showMainApp();
            } else {
                showError('loginError', result.error);
            }
            
            setLoading('loginBtn', 'loginSpinner', 'loginBtnText', false);
        });

        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('createName').value,
                email: document.getElementById('createEmail').value,
                birth_date: document.getElementById('createBirthDate').value,
                address: document.getElementById('createAddress').value,
                dojo_id: parseInt(document.getElementById('createDojo').value),
                status: 'active'
            };
            
            hideError('createError');
            setLoading('createBtn', 'createSpinner', 'createBtnText', true, 'Salvando...');
            
            const result = await createStudent(formData);
            
            if (result.success) {
                hideCreateModal();
                await loadStudents();
                await loadStats();
            } else {
                showError('createError', result.error);
            }
            
            setLoading('createBtn', 'createSpinner', 'createBtnText', false);
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            
            // Verificar se há token armazenado
            const token = localStorage.getItem('authToken');
            const storedUser = localStorage.getItem('currentUser');
            
            if (token && storedUser) {
                try {
                    // Verificar se o token ainda é válido
                    const response = await apiRequest('/auth/me');
                    currentUser = response.user;
                    showMainApp();
                } catch (error) {
                    // Token inválido, limpar localStorage
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('currentUser');
                    showLoginScreen();
                }
            } else {
                showLoginScreen();
            }
        });
    </script>
</body>
</html>
